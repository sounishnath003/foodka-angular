import * as tslib_1 from "tslib";
import { DateTime } from 'luxon';
import { TimeFormat } from '../models/time-format.enum';
import { TimePeriod } from '../models/time-period.enum';
import { isBetween, isSameOrAfter, isSameOrBefore } from '../utils/timepicker.utils';
// @dynamic
var TimeAdapter = /** @class */ (function () {
    function TimeAdapter() {
    }
    TimeAdapter.parseTime = function (time, opts) {
        var _a = TimeAdapter.getLocaleOptionsByTime(time, opts), numberingSystem = _a.numberingSystem, locale = _a.locale;
        var isPeriodExist = time.split(' ').length === 2;
        var timeMask = isPeriodExist ? TimeFormat.TWELVE_SHORT : TimeFormat.TWENTY_FOUR_SHORT;
        return DateTime.fromFormat(time, timeMask, { numberingSystem: numberingSystem, locale: locale });
    };
    TimeAdapter.formatTime = function (time, opts) {
        var format = opts.format;
        var parsedTime = TimeAdapter.parseTime(time, opts).setLocale(TimeAdapter.DEFAULT_LOCALE);
        if (format !== 24) {
            return parsedTime.toLocaleString(tslib_1.__assign({}, DateTime.TIME_SIMPLE, { hour12: format !== 24, numberingSystem: TimeAdapter.DEFAULT_NUMBERING_SYSTEM })).replace(/\u200E/g, '');
        }
        return parsedTime.toISOTime({
            includeOffset: false,
            suppressMilliseconds: true,
            suppressSeconds: true
        }).replace(/\u200E/g, '');
    };
    TimeAdapter.toLocaleTimeString = function (time, opts) {
        if (opts === void 0) { opts = {}; }
        var _a = opts.format, format = _a === void 0 ? TimeAdapter.DEFAULT_FORMAT : _a, _b = opts.locale, locale = _b === void 0 ? TimeAdapter.DEFAULT_LOCALE : _b;
        var timeFormat = tslib_1.__assign({}, DateTime.TIME_SIMPLE, { hour12: format !== 24 });
        var timeMask = (format === 24) ? TimeFormat.TWENTY_FOUR_SHORT : TimeFormat.TWELVE_SHORT;
        return DateTime.fromFormat(time, timeMask).setLocale(locale).toLocaleString(timeFormat);
    };
    TimeAdapter.isTimeAvailable = function (time, min, max, granularity, minutesGap, format) {
        if (!time) {
            return;
        }
        var convertedTime = this.parseTime(time, { format: format });
        var minutes = convertedTime.minute;
        if (minutesGap && minutes === minutes && minutes % minutesGap !== 0) {
            throw new Error("Your minutes - " + minutes + " doesn't match your minutesGap - " + minutesGap);
        }
        var isAfter = (min && !max)
            && isSameOrAfter(convertedTime, min, granularity);
        var isBefore = (max && !min)
            && isSameOrBefore(convertedTime, max, granularity);
        var between = (min && max)
            && isBetween(convertedTime, min, max, granularity);
        var isAvailable = !min && !max;
        return isAfter || isBefore || between || isAvailable;
    };
    /***
     *  Format hour according to time format (12 or 24)
     */
    TimeAdapter.formatHour = function (currentHour, format, period) {
        if (format === 24) {
            return currentHour;
        }
        var hour = period === TimePeriod.AM ? currentHour : currentHour + 12;
        if (period === TimePeriod.AM && hour === 12) {
            return 0;
        }
        else if (period === TimePeriod.PM && hour === 24) {
            return 12;
        }
        return hour;
    };
    TimeAdapter.fromDateTimeToString = function (time, format) {
        var timeFormat = format === 24 ? TimeFormat.TWENTY_FOUR : TimeFormat.TWELVE;
        return time.reconfigure({
            numberingSystem: TimeAdapter.DEFAULT_NUMBERING_SYSTEM,
            locale: TimeAdapter.DEFAULT_LOCALE
        }).toFormat(timeFormat);
    };
    TimeAdapter.getLocaleOptionsByTime = function (time, opts) {
        var _a = DateTime.local().setLocale(opts.locale).resolvedLocaleOpts(), numberingSystem = _a.numberingSystem, locale = _a.locale;
        var localeConfig = { numberingSystem: numberingSystem, locale: locale };
        var defaultConfig = { numberingSystem: TimeAdapter.DEFAULT_NUMBERING_SYSTEM, locale: TimeAdapter.DEFAULT_LOCALE };
        return isNaN(parseInt(time, 10)) ? localeConfig : defaultConfig;
    };
    TimeAdapter.DEFAULT_FORMAT = 12;
    TimeAdapter.DEFAULT_LOCALE = 'en-US';
    TimeAdapter.DEFAULT_NUMBERING_SYSTEM = 'latn';
    return TimeAdapter;
}());
export { TimeAdapter };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZS1hZGFwdGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LW1hdGVyaWFsLXRpbWVwaWNrZXIvIiwic291cmNlcyI6WyJzcmMvYXBwL21hdGVyaWFsLXRpbWVwaWNrZXIvc2VydmljZXMvdGltZS1hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsUUFBUSxFQUF3RCxNQUFNLE9BQU8sQ0FBQztBQUV0RixPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFDdEQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLDRCQUE0QixDQUFDO0FBQ3RELE9BQU8sRUFBQyxTQUFTLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBR25GLFdBQVc7QUFDWDtJQUFBO0lBcUdBLENBQUM7SUFoR1UscUJBQVMsR0FBaEIsVUFBaUIsSUFBWSxFQUFFLElBQWlCO1FBQ3RDLElBQUEsbURBQTBFLEVBQXpFLG9DQUFlLEVBQUUsa0JBQXdELENBQUM7UUFDakYsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDO1FBQ25ELElBQU0sUUFBUSxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDO1FBRXhGLE9BQU8sUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLEVBQUMsZUFBZSxpQkFBQSxFQUFFLE1BQU0sUUFBQSxFQUFDLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRU0sc0JBQVUsR0FBakIsVUFBa0IsSUFBWSxFQUFFLElBQWlCO1FBQ3RDLElBQUEsb0JBQU0sQ0FBUztRQUN0QixJQUFNLFVBQVUsR0FBRyxXQUFXLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsV0FB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QUFDO0lBQ3BCLDBCQUFjLEdBQUcsT0FBTyxDQUFDO0lBQ3pCLG9DQUF3QixHQUFvQixNQUFNLENBQUM7SUFrRzlELGtCQUFDO0NBQUEsQUFyR0QsSUFxR0M7U0FyR1ksV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RGF0ZVRpbWUsIERhdGVUaW1lRm9ybWF0T3B0aW9ucywgTG9jYWxlT3B0aW9ucywgTnVtYmVyaW5nU3lzdGVtfSBmcm9tICdsdXhvbic7XG5cbmltcG9ydCB7VGltZUZvcm1hdH0gZnJvbSAnLi4vbW9kZWxzL3RpbWUtZm9ybWF0LmVudW0nO1xuaW1wb3J0IHtUaW1lUGVyaW9kfSBmcm9tICcuLi9tb2RlbHMvdGltZS1wZXJpb2QuZW51bSc7XG5pbXBvcnQge2lzQmV0d2VlbiwgaXNTYW1lT3JBZnRlciwgaXNTYW1lT3JCZWZvcmV9IGZyb20gJy4uL3V0aWxzL3RpbWVwaWNrZXIudXRpbHMnO1xuaW1wb3J0IHtUaW1lT3B0aW9uc30gZnJvbSAnLi4vbW9kZWxzL3RpbWUtb3B0aW9ucy5pbnRlcmZhY2UnO1xuXG4vLyBAZHluYW1pY1xuZXhwb3J0IGNsYXNzIFRpbWVBZGFwdGVyIHtcbiAgICBzdGF0aWMgREVGQVVMVF9GT1JNQVQgPSAxMjtcbiAgICBzdGF0aWMgREVGQVVMVF9MT0NBTEUgPSAnZW4tVVMnO1xuICAgIHN0YXRpYyBERUZBVUxUX05VTUJFUklOR19TWVNURU06IE51bWJlcmluZ1N5c3RlbSA9ICdsYXRuJztcblxuICAgIHN0YXRpYyBwYXJzZVRpbWUodGltZTogc3RyaW5nLCBvcHRzOiBUaW1lT3B0aW9ucyk6IERhdGVUaW1lIHtcbiAgICAgICAgY29uc3Qge251bWJlcmluZ1N5c3RlbSwgbG9jYWxlfSA9IFRpbWVBZGFwdGVyLmdldExvY2FsZU9wdGlvbnNCeVRpbWUodGltZSwgb3B0cyk7XG4gICAgICAgIGNvbnN0IGlzUGVyaW9kRXhpc3QgPSB0aW1lLnNwbGl0KCcgJykubGVuZ3RoID09PSAyO1xuICAgICAgICBjb25zdCB0aW1lTWFzayA9IGlzUGVyaW9kRXhpc3QgPyBUaW1lRm9ybWF0LlRXRUxWRV9TSE9SVCA6IFRpbWVGb3JtYXQuVFdFTlRZX0ZPVVJfU0hPUlQ7XG5cbiAgICAgICAgcmV0dXJuIERhdGVUaW1lLmZyb21Gb3JtYXQodGltZSwgdGltZU1hc2ssIHtudW1iZXJpbmdTeXN0ZW0sIGxvY2FsZX0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBmb3JtYXRUaW1lKHRpbWU6IHN0cmluZywgb3B0czogVGltZU9wdGlvbnMpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCB7Zm9ybWF0fSA9IG9wdHM7XG4gICAgICAgIGNvbnN0IHBhcnNlZFRpbWUgPSBUaW1lQWRhcHRlci5wYXJzZVRpbWUodGltZSwgb3B0cykuc2V0TG9jYWxlKFRpbWVBZGFwdGVyLkRFRkFVTFRfTE9DQUxFKTtcblxuICAgICAgICBpZiAoZm9ybWF0ICE9PSAyNCkge1xuICAgICAgICAgICAgcmV0dXJuIHBhcnNlZFRpbWUudG9Mb2NhbGVTdHJpbmcoe1xuICAgICAgICAgICAgICAgIC4uLkRhdGVUaW1lLlRJTUVfU0lNUExFLFxuICAgICAgICAgICAgICAgIGhvdXIxMjogZm9ybWF0ICE9PSAyNCxcbiAgICAgICAgICAgICAgICBudW1iZXJpbmdTeXN0ZW06IFRpbWVBZGFwdGVyLkRFRkFVTFRfTlVNQkVSSU5HX1NZU1RFTVxuICAgICAgICAgICAgfSkucmVwbGFjZSgvXFx1MjAwRS9nLCAnJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBhcnNlZFRpbWUudG9JU09UaW1lKHtcbiAgICAgICAgICAgIGluY2x1ZGVPZmZzZXQ6IGZhbHNlLFxuICAgICAgICAgICAgc3VwcHJlc3NNaWxsaXNlY29uZHM6IHRydWUsXG4gICAgICAgICAgICBzdXBwcmVzc1NlY29uZHM6IHRydWVcbiAgICAgICAgfSkucmVwbGFjZSgvXFx1MjAwRS9nLCAnJyk7XG4gICAgfVxuXG4gICAgc3RhdGljIHRvTG9jYWxlVGltZVN0cmluZyh0aW1lOiBzdHJpbmcsIG9wdHM6IFRpbWVPcHRpb25zID0ge30pOiBzdHJpbmcge1xuICAgICAgICBjb25zdCB7Zm9ybWF0ID0gVGltZUFkYXB0ZXIuREVGQVVMVF9GT1JNQVQsIGxvY2FsZSA9IFRpbWVBZGFwdGVyLkRFRkFVTFRfTE9DQUxFfSA9IG9wdHM7XG4gICAgICAgIGNvbnN0IHRpbWVGb3JtYXQ6IERhdGVUaW1lRm9ybWF0T3B0aW9ucyA9IHsuLi5EYXRlVGltZS5USU1FX1NJTVBMRSwgaG91cjEyOiBmb3JtYXQgIT09IDI0fTtcbiAgICAgICAgY29uc3QgdGltZU1hc2sgPSAoZm9ybWF0ID09PSAyNCkgPyBUaW1lRm9ybWF0LlRXRU5UWV9GT1VSX1NIT1JUIDogVGltZUZvcm1hdC5UV0VMVkVfU0hPUlQ7XG5cbiAgICAgICAgcmV0dXJuIERhdGVUaW1lLmZyb21Gb3JtYXQodGltZSwgdGltZU1hc2spLnNldExvY2FsZShsb2NhbGUpLnRvTG9jYWxlU3RyaW5nKHRpbWVGb3JtYXQpO1xuICAgIH1cblxuICAgIHN0YXRpYyBpc1RpbWVBdmFpbGFibGUoXG4gICAgICAgIHRpbWU6IHN0cmluZyxcbiAgICAgICAgbWluPzogRGF0ZVRpbWUsXG4gICAgICAgIG1heD86IERhdGVUaW1lLFxuICAgICAgICBncmFudWxhcml0eT86ICdob3VycycgfCAnbWludXRlcycsXG4gICAgICAgIG1pbnV0ZXNHYXA/OiBudW1iZXIsXG4gICAgICAgIGZvcm1hdD86IG51bWJlclxuICAgICk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoIXRpbWUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNvbnZlcnRlZFRpbWUgPSB0aGlzLnBhcnNlVGltZSh0aW1lLCB7Zm9ybWF0fSk7XG4gICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBjb252ZXJ0ZWRUaW1lLm1pbnV0ZTtcblxuICAgICAgICBpZiAobWludXRlc0dhcCAmJiBtaW51dGVzID09PSBtaW51dGVzICYmIG1pbnV0ZXMgJSBtaW51dGVzR2FwICE9PSAwKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFlvdXIgbWludXRlcyAtICR7bWludXRlc30gZG9lc25cXCd0IG1hdGNoIHlvdXIgbWludXRlc0dhcCAtICR7bWludXRlc0dhcH1gKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpc0FmdGVyID0gKG1pbiAmJiAhbWF4KVxuICAgICAgICAgICAgJiYgaXNTYW1lT3JBZnRlcihjb252ZXJ0ZWRUaW1lLCBtaW4sIGdyYW51bGFyaXR5KTtcbiAgICAgICAgY29uc3QgaXNCZWZvcmUgPSAobWF4ICYmICFtaW4pXG4gICAgICAgICAgICAmJiBpc1NhbWVPckJlZm9yZShjb252ZXJ0ZWRUaW1lLCBtYXgsIGdyYW51bGFyaXR5KTtcbiAgICAgICAgY29uc3QgYmV0d2VlbiA9IChtaW4gJiYgbWF4KVxuICAgICAgICAgICAgJiYgaXNCZXR3ZWVuKGNvbnZlcnRlZFRpbWUsIG1pbiwgbWF4LCBncmFudWxhcml0eSk7XG4gICAgICAgIGNvbnN0IGlzQXZhaWxhYmxlID0gIW1pbiAmJiAhbWF4O1xuXG4gICAgICAgIHJldHVybiBpc0FmdGVyIHx8IGlzQmVmb3JlIHx8IGJldHdlZW4gfHwgaXNBdmFpbGFibGU7XG4gICAgfVxuXG4gICAgLyoqKlxuICAgICAqICBGb3JtYXQgaG91ciBhY2NvcmRpbmcgdG8gdGltZSBmb3JtYXQgKDEyIG9yIDI0KVxuICAgICAqL1xuICAgIHN0YXRpYyBmb3JtYXRIb3VyKGN1cnJlbnRIb3VyOiBudW1iZXIsIGZvcm1hdDogbnVtYmVyLCBwZXJpb2Q6IFRpbWVQZXJpb2QpOiBudW1iZXIge1xuICAgICAgICBpZiAoZm9ybWF0ID09PSAyNCkge1xuICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRIb3VyO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGhvdXIgPSBwZXJpb2QgPT09IFRpbWVQZXJpb2QuQU0gPyBjdXJyZW50SG91ciA6IGN1cnJlbnRIb3VyICsgMTI7XG5cbiAgICAgICAgaWYgKHBlcmlvZCA9PT0gVGltZVBlcmlvZC5BTSAmJiBob3VyID09PSAxMikge1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH0gZWxzZSBpZiAocGVyaW9kID09PSBUaW1lUGVyaW9kLlBNICYmIGhvdXIgPT09IDI0KSB7XG4gICAgICAgICAgICByZXR1cm4gMTI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGhvdXI7XG4gICAgfVxuXG4gICAgc3RhdGljIGZyb21EYXRlVGltZVRvU3RyaW5nKHRpbWU6IERhdGVUaW1lLCBmb3JtYXQ6IG51bWJlcik6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHRpbWVGb3JtYXQgPSBmb3JtYXQgPT09IDI0ID8gVGltZUZvcm1hdC5UV0VOVFlfRk9VUiA6IFRpbWVGb3JtYXQuVFdFTFZFO1xuXG4gICAgICAgIHJldHVybiB0aW1lLnJlY29uZmlndXJlKHtcbiAgICAgICAgICAgIG51bWJlcmluZ1N5c3RlbTogVGltZUFkYXB0ZXIuREVGQVVMVF9OVU1CRVJJTkdfU1lTVEVNLFxuICAgICAgICAgICAgbG9jYWxlOiBUaW1lQWRhcHRlci5ERUZBVUxUX0xPQ0FMRVxuICAgICAgICB9KS50b0Zvcm1hdCh0aW1lRm9ybWF0KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBnZXRMb2NhbGVPcHRpb25zQnlUaW1lKHRpbWU6IHN0cmluZywgb3B0czogVGltZU9wdGlvbnMpOiBMb2NhbGVPcHRpb25zIHtcbiAgICAgICAgY29uc3Qge251bWJlcmluZ1N5c3RlbSwgbG9jYWxlfSA9IERhdGVUaW1lLmxvY2FsKCkuc2V0TG9jYWxlKG9wdHMubG9jYWxlKS5yZXNvbHZlZExvY2FsZU9wdHMoKTtcbiAgICAgICAgY29uc3QgbG9jYWxlQ29uZmlnOiBMb2NhbGVPcHRpb25zID0ge251bWJlcmluZ1N5c3RlbTogbnVtYmVyaW5nU3lzdGVtIGFzIE51bWJlcmluZ1N5c3RlbSwgbG9jYWxlfTtcbiAgICAgICAgY29uc3QgZGVmYXVsdENvbmZpZzogTG9jYWxlT3B0aW9ucyA9IHtudW1iZXJpbmdTeXN0ZW06IFRpbWVBZGFwdGVyLkRFRkFVTFRfTlVNQkVSSU5HX1NZU1RFTSwgbG9jYWxlOiBUaW1lQWRhcHRlci5ERUZBVUxUX0xPQ0FMRX07XG5cbiAgICAgICAgcmV0dXJuIGlzTmFOKHBhcnNlSW50KHRpbWUsIDEwKSkgPyBsb2NhbGVDb25maWcgOiBkZWZhdWx0Q29uZmlnO1xuICAgIH1cbn1cbiJdfQ==